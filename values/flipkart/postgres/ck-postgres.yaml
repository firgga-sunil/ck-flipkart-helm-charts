apiVersion: acid.zalan.do/v1
kind: postgresql
metadata:
  name: ck-postgres
  namespace: codekarma

spec:
  enableLogicalBackup: true
  teamId: flipkart
  numberOfInstances: 2
  additionalVolumes:
    - name: sql-scripts-volume
      mountPath: /scripts
      targetContainers:
        - init-sql
      volumeSource:
        configMap:
          name: ck-postgres-init-sql
  initContainers:
    - name: init-sql-script
      image:
        registry: ghcr.io
        repository: zalando/postgres-operator
        tag: v1.15.
      env:
        - name: PGPASSWORD
          valueFrom:
            secretKeyRef:
              name: cknexus.ck-postgres.credentials.postgresql.acid.zalan.do
              key: password
      volumeMounts:
        - name: init-script-volume
          mountPath: /init-scripts
  serviceAccountName: postgres-pod
  postgresql:
    version: "15"

  volume:
    size: 10Gi
    storageClass: ckn-gcp-sc

  users:
    cknexus:
      - superuser
      - createdb
  env:
    - name: WAL_GS_BUCKET
      value: "ck-flipkart-pg-storage-bucket/prod/"
  databases:
    ckservicedb: cknexus

---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: postgres-pod
  namespace: codekarma
  annotations:
    iam.gke.io/gcp-service-account: codekarma-dev-node-sa@ck-flipkart-pg.iam.gserviceaccount.com
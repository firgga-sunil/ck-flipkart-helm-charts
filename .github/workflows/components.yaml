name: Centralized CI Trigger

on:
  workflow_dispatch:
    inputs:
      component:
        description: "Select component(s) to build"
        type: choice
        required: true
        options:
          - nexus
          - karmalens

      image_tag:
        description: "Docker image tag"
        required: true
        default: ""

jobs:
  trigger-ci:
    runs-on: ubuntu-latest

    steps:
      # ---------------- VALIDATION ----------------
      - name: Validate inputs
        run: |
          if [[ -z "${{ inputs.image_tag }}" ]]; then
            echo "ERROR: Image tag is required"
            exit 1
          fi

      # ---------------- DISPATCH LOGIC ----------------
      - name: Trigger selected CI pipelines
        env:
          COMPONENT: ${{ inputs.component }}
          IMAGE_TAG: ${{ inputs.image_tag }}
          TOKEN: ${{ secrets.REPO_DISPATCH_TOKEN }}
        run: |
          case "$COMPONENT" in
            nexus)
              REPOS=("ck-nexus")
              ;;
            karmalens)
              REPOS=("karma-lens")
              ;;
            all)
              REPOS=("ck-nexus" "karma-lens")
              ;;
            *)
              echo "Invalid component"
              exit 1
              ;;
          esac

          for REPO in "${REPOS[@]}"; do
            echo "Triggering CI for $REPO"

            curl -X POST \
              -H "Accept: application/vnd.github+json" \
              -H "Authorization: Bearer $TOKEN" \
              https://api.github.com/repos/codekarma-tech/${REPO}/dispatches \
              -d "$(jq -n \
                --arg tag "$IMAGE_TAG" \
                '{event_type:"build-image", client_payload:{tag:$tag}}'
              )"
          done


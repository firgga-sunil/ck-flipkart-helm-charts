name: Docker Image Build Orchestration

on:
  workflow_dispatch:
    inputs:
      component:
        description: "Select component(s) to build"
        type: choice
        required: true
        options:
          - nexus
          - karmalens

      image_tag:
        description: "Docker image tag"
        required: true
        default: ""

jobs:
  trigger-ci:
    runs-on: ubuntu-latest

    steps:
      # ---------------- VALIDATION ----------------
      - name: Validate inputs
        run: |
          if [[ -z "${{ inputs.image_tag }}" ]]; then
            echo "ERROR: Image tag is required"
            exit 1
          fi

      # ---------------- DISPATCH WORKFLOW ----------------
      - name: Trigger build workflow
        env:
          COMPONENT: ${{ inputs.component }}
          IMAGE_TAG: ${{ inputs.image_tag }}
          TOKEN: ${{ secrets.PERSONAL_ACCESS_TOKEN }}
        run: |
          case "$COMPONENT" in
            nexus)
              REPOS=("ck-nexus")
              ;;
            karmalens)
              REPOS=("karma-lens")
              ;;
            *)
              echo "Invalid component"
              exit 1
              ;;
          esac

          for REPO in "${REPOS[@]}"; do
            echo "Triggering build workflow for $REPO"

            curl -s -X POST \
              -H "Accept: application/vnd.github+json" \
              -H "Authorization: Bearer $TOKEN" \
              https://api.github.com/repos/codekarma-tech/${REPO}/dispatches \
              -d "$(jq -n \
                --arg component "$COMPONENT" \
                --arg tag "$IMAGE_TAG" \
                '{event_type:"trigger-build-workflow", client_payload:{component:$component, tag:$tag}}'
              )"
          done

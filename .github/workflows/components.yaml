name: Docker Image CI Orchestration

on:
  workflow_dispatch:
    inputs:
      component:
        description: "Select repository to build"
        type: choice
        required: true
        options:
          - ck-flipkart-helm-charts
          - karma-lens


jobs:
  trigger-ci:
    runs-on: ubuntu-latest

    steps:

      # ---------------- DISPATCH WORKFLOW ----------------
      - name: Trigger build workflow
        env:
          REPO: ${{ inputs.component }}
          TOKEN: ${{ secrets.PERSONAL_ACCESS_TOKEN }}
        run: |
          echo "Triggering build workflow for $REPO"

          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer $TOKEN" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            https://api.github.com/repos/firgga-sunil/${REPO}/dispatches \
            -d "$(jq -n \
              --arg repo "$REPO" \
              '{event_type:"trigger-build-workflow", client_payload:{repository:$repo}}'
            )")
          
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          
          if [ "$HTTP_CODE" -eq 204 ]; then
            echo "✓ Successfully triggered workflow for $REPO"
          else
            echo "✗ Failed to trigger workflow for $REPO (HTTP $HTTP_CODE)"
            echo "$RESPONSE" | head -n-1
            exit 1
          fi

      - name: Summary
        if: always()
        run: |
          echo "### Workflow Trigger Summary" >> $GITHUB_STEP_SUMMARY
          echo "Repository: ${{ inputs.component }}" >> $GITHUB_STEP_SUMMARY
          echo "Status: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
